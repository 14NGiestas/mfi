#:def getri(f77,f90,mfi,pfxs)
#:set wp = pfxs[0]
subroutine test_${f77}$
    use f77_lapack, only: ${f77}$, ${f90}$, f77_getrf, ${wp[0]}$getrf
    use mfi_lapack, only: ${mfi}$, mfi_${f77}$

    integer, parameter :: wp = ${kind(wp)}$
    integer, parameter :: N = 3
    ${type(wp)}$ :: A(N,N), A_in(N,N), A_rf(N,N), A_copy(N,N)
    integer :: ipiv(N), info, info_rf, info_mfi
    ${type(wp)}$, allocatable :: work(:)
    integer :: lwork

    ! Create an invertible matrix
    A_copy(1,:) = [2.0_wp, 0.0_wp, 1.0_wp]
    A_copy(2,:) = [1.0_wp, 2.0_wp, 0.0_wp]
    A_copy(3,:) = [0.0_wp, 1.0_wp, 2.0_wp]

    ! Factor the matrix first with getrf to prepare for getri
    A = A_copy
    call ${wp[0]}$getrf(N, N, A, N, ipiv, info)
    if (info /= 0) return  ! Skip test if factorization failed

    ! Test f77 interface for getri
    A_in = A  ! A is now the factorized matrix
    allocate(work(1))  ! Small workspace for query
    lwork = -1  ! Workspace query
    call ${f77}$(N, A_in, N, ipiv, work, lwork, info)
    if (info == 0) then
        lwork = int(real(work(1), wp))  ! Get workspace size
        deallocate(work)
        allocate(work(max(1, lwork)))

        A_in = A  ! Use the factored matrix again
        call ${f77}$(N, A_in, N, ipiv, work, lwork, info)
        A_rf = A_in
        info_rf = info
        deallocate(work)
    else
        return ! Skip if workspace query failed
    end if

    if (info /= 0) return  ! Skip test if getri failed

    ! Test mfi interface (short form)
    ! We need to factorize again as getri overwrites the input
    A = A_copy
    call f77_getrf(N, N, A, N, ipiv, info)
    if (info /= 0) return  ! Skip if factorization failed again

    A_in = A
    call mfi_${f77}$(A_in, ipiv, info=info_mfi)
    call assert(all(abs(A_in - A_rf) < 1e-8) .and. info_mfi == info_rf, "different results for mfi_${f77}$")

    ! Test mfi interface (full form)
    A = A_copy
    call f77_getrf(N, N, A, N, ipiv, info)
    if (info /= 0) return  ! Skip if factorization failed again

    A_in = A
    call ${mfi}$(A_in, ipiv, info=info_mfi)
    call assert(all(abs(A_in - A_rf) < 1e-8) .and. info_mfi == info_rf, "different results for ${mfi}$")

end subroutine
#:enddef
