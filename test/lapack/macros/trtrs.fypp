#:def trtrs(f77,f90,mfi,pfxs)
#:set wp = pfxs[0]
subroutine test_${f77}$
    use f77_lapack, only: ${f77}$, ${f90}$
    use mfi_lapack, only: ${mfi}$, mfi_${f77}$

    integer, parameter :: wp = ${kind(wp)}$
    integer, parameter :: N = 3, NRHS = 2
    ${type(wp)}$ :: A(N,N), B(N,NRHS), B_in(N,NRHS), B_rf(N,NRHS)
    integer :: info, info_rf, info_mfi

    ! Create a triangular matrix A
    A = reshape([4.0_wp, 0.0_wp, 0.0_wp, &  ! column 1
                 2.0_wp, 3.0_wp, 0.0_wp, &  ! column 2
                 1.0_wp, 2.0_wp, 5.0_wp], [N,N]) ! column 3

    ! Create B matrix such that A*X = [1,2; 2,1; 1,0] is the solution
    ! So B should be A * [1,2; 2,1; 1,0] = [4*1+0*2+0*1, 4*2+0*1+0*0; 2*1+3*2+0*1, 2*2+3*1+0*0; 1*1+2*2+5*1, 1*2+2*1+5*0]
    ! = [4,8; 8,7; 10,4]
    B = reshape([4.0_wp, 8.0_wp, 10.0_wp, &  ! column 1
                 8.0_wp, 7.0_wp, 4.0_wp], [N,NRHS]) ! column 2

    ! Test f77 interface for trtrs
    B_in = B
    call ${f77}$('U', 'N', 'N', N, NRHS, A, N, B_in, N, info)
    B_rf = B_in
    info_rf = info
    
    call assert(info == 0, "f77_${f77}$ failed", info)

    ! Test mfi interface (short form)
    B_in = B
    call mfi_${f77}$(A, B_in, info=info_mfi)
    call assert(info_mfi == info_rf .and. all(abs(B_in - B_rf) < 1e-10), &
                "different results for mfi_${f77}$")

    ! Test mfi interface (full form)
    B_in = B
    call ${mfi}$(A, B_in, info=info_mfi)
    call assert(info_mfi == info_rf .and. all(abs(B_in - B_rf) < 1e-10), &
                "different results for ${mfi}$")

end subroutine
#:enddef
