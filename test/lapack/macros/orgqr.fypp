#:def orgqr(f77,f90,mfi,pfxs)
#:set wp = pfxs[0]
subroutine test_${f77}$
    use f77_lapack, only: ${f77}$, geqrf => ${f90('geqrf')}$
    use mfi_lapack, only: ${mfi}$, mfi_${f77}$, mfi_geqrf

    integer, parameter :: wp = ${kind(wp)}$
    integer, parameter :: N = 4
    ${type(wp)}$ :: A(N,N), A_in(N,N), A_rf(N,N)
    ${type(wp)}$ :: tau_in(N)
    integer :: info, info_rf, info_mfi
    ${type(wp)}$, allocatable :: work(:)
    integer :: lwork

    ! Create a test matrix
    A = reshape([3.0_wp, 1.0_wp, 1.0_wp, 1.0_wp, &
                 1.0_wp, 3.0_wp, 1.0_wp, 1.0_wp, &
                 1.0_wp, 1.0_wp, 3.0_wp, 1.0_wp, &
                 1.0_wp, 1.0_wp, 1.0_wp, 3.0_wp], [N,N])

    ! Compute QR factorization using geqrf to get the tau values needed for orgqr
    A_in = A
    call mfi_geqrf(A_in, tau_in, info=info)
    if (info /= 0) return  ! Skip test if geqrf fails

    ! Store the result of the factorization
    A_rf = A_in

    ! Test f77 interface for orgqr (workspace query and execution)
    allocate(work(1))
    lwork = -1
    call ${f77}$(N, N, N, A_in, N, tau_in, work, lwork, info)
    if (info == 0) then
        lwork = int(real(work(1), wp))
        if (lwork <= 0) lwork = N*N
        deallocate(work)
        allocate(work(max(1, lwork)))

        A_in = A_rf  ! Reset to factorized matrix
        call ${f77}$(N, N, N, A_in, N, tau_in, work, lwork, info)
        A_rf = A_in  ! Store the computed Q matrix from f77 interface
        info_rf = info
        deallocate(work)
    else
        if (allocated(work)) deallocate(work)
        return  ! Skip if orgqr workspace query failed
    end if

    if (info /= 0) return  ! Skip test if f77 interface failed

    ! Test mfi interface (short form)
    A_in = A
    call mfi_geqrf(A_in, tau_in, info=info)
    if (info /= 0) return  ! Skip if geqrf fails

    call mfi_${f77}$(A_in, tau_in, info=info_mfi)
    call assert(info_mfi == info_rf .and. all(abs(A_in - A_rf) < sqrt(epsilon(1.0_wp))), &
                "different results for mfi_${f77}$")

    ! Test mfi interface (full form)
    A_in = A
    call mfi_geqrf(A_in, tau_in, info=info)
    if (info /= 0) return  ! Skip if geqrf fails

    call ${mfi}$(A_in, tau_in, info=info_mfi)
    call assert(info_mfi == info_rf .and. all(abs(A_in - A_rf) < sqrt(epsilon(1.0_wp))), &
                "different results for ${mfi}$")

end subroutine
#:enddef