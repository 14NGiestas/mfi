name: fpm-deployment

on: [push, pull_request]
env:
  PROJECT_NAME: "mfi"

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            toolchain: {compiler: gcc, version: 13}
    steps:
    - name: Checkout üõéÔ∏è
      uses: actions/checkout@v2.3.1

    - name: Set up Python 3.x
      uses: actions/setup-python@v1
      with:
        python-version: 3.x

    - name: Install fypp
      run: pip install --upgrade fypp

    - name: Generate ${{ env.PROJECT_NAME }}-fpm package üîß
      run: |
        make FYPPFLAGS=-DMFI_EXTENSIONS
        mkdir mfi-fpm
        cp -R src   mfi-fpm
        cp -R test  mfi-fpm
        cp fpm.toml mfi-fpm
        cp LICENSE  mfi-fpm
        find mfi-fpm/src  -type f ! -name "*.f90" -delete
        find mfi-fpm/test -type f ! -name "*.f90" -delete
    
    - name: setup fortran
      uses: fortran-lang/setup-fortran@main
      id: setup-fortran
      with:
        compiler: ${{ matrix.toolchain.compiler }}
        version: ${{ matrix.toolchain.version }}

    - name: Install Lapack and Blas
      run: |
        sudo apt install libblas-dev liblapack-dev libtmglib-dev

    - name: Install fpm latest release
      uses: fortran-lang/setup-fpm@v5
      with:
        fpm-version: 'v0.10.0'

    - name: Run fpm build ‚öô
      run: |
        fpm build --profile release

    # Update and deploy the f90 files generated by github-ci to the `PROJECT_NAME-fpm` branch.
    - name: Deploy üöÄ
      uses: JamesIves/github-pages-deploy-action@4.1.5
      if: github.event_name != 'pull_request'
      with:
        BRANCH: ${{ env.PROJECT_NAME }}-fpm
        FOLDER: mfi-fpm
